<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é«˜çº§é‚®ä»¶å‘é€å™¨ (æœ€ç»ˆç‰ˆ)</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css"/>
    <style>
        :root { --pico-font-size: 100%; }
        body { padding: 1.5rem; }
        main.container { max-width: 1200px; }
        #email-section, #history-section, dialog { display: none; }
        .grid-preview { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; transition: grid-template-columns 0.3s ease-in-out; }
        .grid-preview.preview-hidden { grid-template-columns: 1fr; }
        #live-preview-container { transition: opacity 0.3s ease-in-out; }
        .grid-preview.preview-hidden #live-preview-container { display: none; }

        #response { margin-top: 1rem; padding: 1rem; border-radius: var(--pico-border-radius); display: none; }
        #response.success { background-color: var(--pico-color-green-200); color: var(--pico-color-green-950); }
        #response.error { background-color: var(--pico-color-red-200); color: var(--pico-color-red-950); }
        #html-toolbar button { padding: 0.25rem 0.5rem; margin-right: 0.5rem; }
        dialog article { padding: 1.5rem; }
        #details-modal-content, #settings-modal-content { max-height: 70vh; overflow-y: auto; }
        #header-controls { position: absolute; top: 1.5rem; right: 1.5rem; display: flex; gap: 1rem; }
        
        /* --- æ ·å¼ä¼˜åŒ– --- */
        [data-theme='dark'] #live-preview, [data-theme='dark'] #details-modal-preview {
            background-color: #f1f3f5;
            color: #111827;
        }
        #history-list table { border-collapse: separate; border-spacing: 0; }
        #history-list th, #history-list td { padding: 0.75rem 1rem; text-align: left; }
        #history-list tbody tr { border-bottom: 1px solid var(--pico-table-border-color); transition: background-color 0.2s ease-in-out; }
        #history-list tbody tr:last-child { border-bottom: none; }
        #history-list tbody tr:hover { cursor: pointer; background-color: var(--pico-card-background-color); }
        
        #attachment-list { margin-top: 0.75rem; display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .attachment-item { background-color: var(--pico-secondary-background); padding: 0.35rem 0.75rem; border-radius: var(--pico-border-radius); display: flex; align-items: center; gap: 0.75rem; font-size: 0.875rem; }
        .delete-attachment-btn { background: none; border: none; color: var(--pico-secondary-foreground); cursor: pointer; font-weight: bold; padding: 0; line-height: 1; opacity: 0.7; }
        .delete-attachment-btn:hover { opacity: 1; }

        .detail-grid { display: grid; grid-template-columns: auto 1fr; gap: 0.75rem 1.5rem; align-items: baseline; }
        .detail-grid strong { text-align: right; color: var(--pico-hgroup-color); font-weight: normal; }
    </style>
</head>
<body>
    <main class="container">
        <div id="header-controls">
            <button id="settings-btn" class="secondary outline" aria-label="è®¾ç½®">âš™ï¸</button>
            <button id="theme-toggle-btn" class="secondary outline" aria-label="åˆ‡æ¢ä¸»é¢˜">ğŸŒ“</button>
        </div>
        <header>
            <h1>é«˜çº§é‚®ä»¶å‘é€å™¨ ğŸš€</h1>
            <p>ç”± Cloudflare Workers & Resend é©±åŠ¨</p>
        </header>

        <section id="password-section">
            <article><h3 aria-busy="true">è®¿é—®å—é™</h3><form id="passwordForm"><label for="password">å¯†ç </label><input type="password" id="password" name="password" placeholder="è¯·è¾“å…¥å¯†ç ä»¥ç»§ç»­" required><button type="submit">è§£é”</button></form></article>
        </section>

        <section id="email-section">
            <form id="emailForm">
                <div class="grid">
                    <label>æ”¶ä»¶äºº (To)<input type="text" id="to" name="to" placeholder="a@example.com, b@example.com" required></label>
                    <label>å‘ä»¶äºº (From)<input type="text" id="from" name="from" required><small>æ­¤åŸŸåå¿…é¡»åœ¨ Resend ä¸­éªŒè¯ã€‚</small></label>
                </div>
                <div class="grid">
                    <label>æŠ„é€ (CC)<input type="text" id="cc" name="cc" placeholder="c@example.com"></label>
                    <label>å¯†é€ (BCC)<input type="text" id="bcc" name="bcc" placeholder="e@example.com"></label>
                </div>
                <label for="subject">ä¸»é¢˜ (Subject)</label><input type="text" id="subject" name="subject" placeholder="é‚®ä»¶ä¸»é¢˜" required>
                <label for="template">é‚®ä»¶æ¨¡æ¿</label>
                <select id="template"><option value="">-- é€‰æ‹©æ¨¡æ¿ --</option><option value="welcome">æ¬¢è¿é‚®ä»¶</option><option value="reset">å¯†ç é‡ç½®</option></select>
                
                <div class="grid-preview">
                    <div>
                        <!-- å·²ä¿®æ­£ï¼šå°†åˆ‡æ¢æŒ‰é’®ç§»åŠ¨åˆ°æ­¤å¤„ -->
                        <label for="html" style="display: flex; justify-content: space-between; align-items: center;">
                            <span>HTML å†…å®¹</span>
                            <button type="button" id="toggle-preview-btn" class="secondary outline" style="font-size: 0.75rem; padding: 0.1rem 0.5rem; margin-bottom: 0.5rem;">éšè—é¢„è§ˆ</button>
                        </label>
                        <div id="html-toolbar"><button type="button" data-tag="b"><b>B</b></button><button type="button" data-tag="i"><i>I</i></button><button type="button" data-tag="a">é“¾æ¥</button><button type="button" data-tag="img">å›¾ç‰‡</button></div>
                        <textarea id="html" name="html" rows="12" required></textarea>
                    </div>
                    <div id="live-preview-container">
                        <label>å®æ—¶é¢„è§ˆ</label>
                        <div id="live-preview"></div>
                    </div>
                </div>
                <input type="file" id="imageEmbedInput" accept="image/*" style="display: none;">
                
                <div class="grid">
                    <label>å›å¤è‡³ (Reply To)<input type="email" id="reply_to" name="reply_to" placeholder="reply@example.com"></label>
                    <label>å®šæ—¶å‘é€ (ç•™ç©ºåˆ™ç«‹å³å‘é€)<input type="datetime-local" id="scheduled_at" name="scheduled_at"></label>
                </div>

                <label>é™„ä»¶ (å¯é€‰)<input type="file" id="attachment-input" multiple></label>
                <div id="attachment-list"></div>

                <footer>
                    <button type="submit" id="submitBtn">å‘é€é‚®ä»¶</button>
                    <button type="button" id="saveDraftBtn" class="secondary">ä¿å­˜è‰ç¨¿</button>
                    <button type="button" id="loadDraftBtn" class="secondary outline">åŠ è½½è‰ç¨¿</button>
                </footer>
            </form>
            <div id="response"></div>
        </section>

        <section id="history-section"><hr><h2 id="history-title">å‘é€å†å²</h2><div id="history-list"></div><button id="clearHistoryBtn" class="secondary outline">æ¸…ç©ºå†å²</button></section>
    </main>
    
    <dialog id="details-modal"><article><header><button aria-label="Close" rel="prev" id="close-details-modal-btn"></button><p><strong>é‚®ä»¶è¯¦æƒ…</strong></p></header><div id="details-modal-content"></div></article></dialog>
    <dialog id="settings-modal"><article><header><button aria-label="Close" rel="prev" id="close-settings-modal-btn"></button><p><strong>è®¾ç½®</strong></p></header><div id="settings-modal-content"><form id="settingsForm"><label>Worker URL<input type="url" id="setting-worker-url" placeholder="https://your-worker.name.workers.dev" required></label><label>é»˜è®¤å‘ä»¶äººåœ°å€<input type="text" id="setting-from-email" placeholder="Your Name <from@your-verified-domain.com>" required></label><button type="submit">ä¿å­˜è®¾ç½®</button></form></div></article></dialog>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DOM å…ƒç´  ---
        const dom = { passwordForm: document.getElementById('passwordForm'), passwordSection: document.getElementById('password-section'), emailSection: document.getElementById('email-section'), historySection: document.getElementById('history-section'), emailForm: document.getElementById('emailForm'), responseDiv: document.getElementById('response'), submitBtn: document.getElementById('submitBtn'), historyList: document.getElementById('history-list'), clearHistoryBtn: document.getElementById('clearHistoryBtn'), historyTitle: document.getElementById('history-title'), saveDraftBtn: document.getElementById('saveDraftBtn'), loadDraftBtn: document.getElementById('loadDraftBtn'), templateSelector: document.getElementById('template'), htmlToolbar: document.getElementById('html-toolbar'), htmlTextarea: document.getElementById('html'), imageEmbedInput: document.getElementById('imageEmbedInput'), livePreview: document.getElementById('live-preview'), themeToggleBtn: document.getElementById('theme-toggle-btn'), settingsBtn: document.getElementById('settings-btn'), detailsModal: document.getElementById('details-modal'), detailsModalContent: document.getElementById('details-modal-content'), closeDetailsModalBtn: document.getElementById('close-details-modal-btn'), settingsModal: document.getElementById('settings-modal'), settingsForm: document.getElementById('settingsForm'), closeSettingsModalBtn: document.getElementById('close-settings-modal-btn'), fromInput: document.getElementById('from'), workerUrlInput: document.getElementById('setting-worker-url'), fromEmailInput: document.getElementById('setting-from-email'), scheduledAtInput: document.getElementById('scheduled_at'), gridPreview: document.querySelector('.grid-preview'), togglePreviewBtn: document.getElementById('toggle-preview-btn'), attachmentInput: document.getElementById('attachment-input'), attachmentList: document.getElementById('attachment-list') };
        
        // --- çŠ¶æ€ä¸é…ç½® ---
        let config = { WORKER_URL: '', FROM_EMAIL: '', PWD_HASH: 'd8fb238cc20a874529801c28771ed39acde486da770113565862e6c549cfd841' };
        let selectedAttachments = [];

        // --- å‡½æ•° ---
        const showMessage = (msg, isError = false) => { dom.responseDiv.style.display = 'block'; dom.responseDiv.textContent = msg; dom.responseDiv.className = isError ? 'error' : 'success'; };
        const textToHash = async (text) => { const hash = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(text)); return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join(''); };
        const parseEmails = (str) => str.split(',').map(email => email.trim()).filter(Boolean);
        const applyTheme = (theme) => { document.documentElement.setAttribute('data-theme', theme); localStorage.setItem('theme', theme); };
        const loadConfig = () => { const savedConfig = JSON.parse(localStorage.getItem('appConfig')); if (savedConfig) { Object.assign(config, savedConfig); } dom.workerUrlInput.value = config.WORKER_URL; dom.fromEmailInput.value = config.FROM_EMAIL; dom.fromInput.value = config.FROM_EMAIL; };
        
        // --- é™„ä»¶ç®¡ç† ---
        const renderAttachments = () => {
            dom.attachmentList.innerHTML = '';
            selectedAttachments.forEach((file, index) => {
                const item = document.createElement('div');
                item.className = 'attachment-item';
                item.innerHTML = `<span>${file.name}</span><button type="button" class="delete-attachment-btn" data-index="${index}">Ã—</button>`;
                dom.attachmentList.appendChild(item);
            });
        };
        dom.attachmentInput.addEventListener('change', (e) => {
            Array.from(e.target.files).forEach(file => selectedAttachments.push(file));
            renderAttachments();
            dom.attachmentInput.value = ''; // é‡ç½®ä»¥ä¾¿é€‰æ‹©åŒåæ–‡ä»¶
        });
        dom.attachmentList.addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-attachment-btn')) {
                selectedAttachments.splice(e.target.dataset.index, 1);
                renderAttachments();
            }
        });

        const getHistory = () => JSON.parse(localStorage.getItem('emailHistory') || '[]');
        const saveToHistory = (payload, response) => {
            const history = getHistory();
            const newEntry = {
                payload: { ...payload, attachments: payload.attachments ? payload.attachments.map(a => a.filename) : [] }, // åªå­˜æ–‡ä»¶å
                status: response.ok ? 'æˆåŠŸ' : 'å¤±è´¥', id: response.ok ? response.data.id : 'æ— ', timestamp: new Date().toLocaleString()
            };
            history.unshift(newEntry); localStorage.setItem('emailHistory', JSON.stringify(history.slice(0, 50))); renderHistory();
        };
        const renderHistory = () => {
            const history = getHistory(); dom.historyTitle.textContent = `å‘é€å†å² (${history.length})`;
            if (history.length === 0) { dom.historyList.innerHTML = '<p>æ²¡æœ‰æœ€è¿‘çš„å‘é€è®°å½•ã€‚</p>'; return; }
            dom.historyList.innerHTML = `<figure><table><thead><tr><th>æ”¶ä»¶äºº</th><th>ä¸»é¢˜</th><th>çŠ¶æ€</th><th>æ—¥æœŸ</th></tr></thead><tbody>${history.map((item, index) => `<tr data-history-index="${index}"><td>${item.payload.to.join(', ')}</td><td>${item.payload.subject}</td><td>${item.status}</td><td>${item.timestamp}</td></tr>`).join('')}</tbody></table></figure>`;
        };

        // --- åˆå§‹åŒ– ---
        loadConfig();
        applyTheme(localStorage.getItem('theme') || 'dark');

        // --- äº‹ä»¶ç›‘å¬å™¨ ---
        dom.themeToggleBtn.addEventListener('click', () => applyTheme(document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'));
        dom.settingsBtn.addEventListener('click', () => dom.settingsModal.style.display = 'block');
        dom.closeSettingsModalBtn.addEventListener('click', () => dom.settingsModal.style.display = 'none');
        dom.settingsForm.addEventListener('submit', (e) => { e.preventDefault(); const newConfig = { WORKER_URL: dom.workerUrlInput.value, FROM_EMAIL: dom.fromEmailInput.value }; localStorage.setItem('appConfig', JSON.stringify(newConfig)); loadConfig(); showMessage('è®¾ç½®å·²ä¿å­˜ï¼'); dom.settingsModal.style.display = 'none'; });
        dom.passwordForm.addEventListener('submit', async e => { e.preventDefault(); if (await textToHash(document.getElementById('password').value) === config.PWD_HASH) { dom.passwordSection.style.display = 'none'; dom.emailSection.style.display = 'block'; dom.historySection.style.display = 'block'; renderHistory(); } else { alert('å¯†ç é”™è¯¯ã€‚'); } });
        dom.htmlTextarea.addEventListener('input', () => dom.livePreview.innerHTML = dom.htmlTextarea.value);
        dom.togglePreviewBtn.addEventListener('click', () => { dom.gridPreview.classList.toggle('preview-hidden'); dom.togglePreviewBtn.textContent = dom.gridPreview.classList.contains('preview-hidden') ? 'æ˜¾ç¤ºé¢„è§ˆ' : 'éšè—é¢„è§ˆ'; });

        dom.emailForm.addEventListener('submit', async e => {
            e.preventDefault();
            dom.submitBtn.disabled = true; dom.submitBtn.setAttribute('aria-busy', 'true'); dom.responseDiv.style.display = 'none';
            const formData = new FormData(dom.emailForm);
            const payload = { from: formData.get('from'), to: parseEmails(formData.get('to')), subject: formData.get('subject'), html: formData.get('html'), cc: parseEmails(formData.get('cc')), bcc: parseEmails(formData.get('bcc')), reply_to: formData.get('reply_to') || undefined, scheduled_at: dom.scheduledAtInput.value ? new Date(dom.scheduledAtInput.value).toISOString() : undefined };
            Object.keys(payload).forEach(k => { if (!payload[k] || (Array.isArray(payload[k]) && !payload[k].length)) delete payload[k]; });

            const send = async (finalPayload) => {
                try {
                    const response = await fetch(config.WORKER_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(finalPayload) });
                    const result = await response.json();
                    showMessage(response.ok ? `${finalPayload.scheduled_at ? 'å®šæ—¶é‚®ä»¶è®¾ç½®æˆåŠŸ' : 'é‚®ä»¶å‘é€æˆåŠŸ'}ï¼ID: ${result.id}` : `é”™è¯¯: ${result.message || 'æœªçŸ¥é”™è¯¯'}`, !response.ok);
                    if (response.ok) { dom.emailForm.reset(); dom.fromInput.value = config.FROM_EMAIL; dom.livePreview.innerHTML = ''; selectedAttachments = []; renderAttachments(); }
                    saveToHistory(finalPayload, { ok: response.ok, data: result });
                } catch (error) { showMessage(`å‘é€è¯·æ±‚å¤±è´¥: ${error.message}`, true); saveToHistory(finalPayload, { ok: false }); } 
                finally { dom.submitBtn.disabled = false; dom.submitBtn.setAttribute('aria-busy', 'false'); }
            };

            if (selectedAttachments.length > 0) {
                const attachmentPromises = selectedAttachments.map(file => new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve({ filename: file.name, content: reader.result.split(',')[1] });
                    reader.onerror = (err) => reject(err);
                    reader.readAsDataURL(file);
                }));
                try {
                    payload.attachments = await Promise.all(attachmentPromises);
                    send(payload);
                } catch (error) {
                    showMessage('è¯»å–é™„ä»¶æ–‡ä»¶æ—¶å‡ºé”™ã€‚', true); dom.submitBtn.disabled = false; dom.submitBtn.setAttribute('aria-busy', 'false');
                }
            } else { send(payload); }
        });

        dom.saveDraftBtn.addEventListener('click', () => { const draft = {}; new FormData(dom.emailForm).forEach((v, k) => draft[k] = v); localStorage.setItem('emailDraft', JSON.stringify(draft)); showMessage('è‰ç¨¿å·²ä¿å­˜ï¼'); });
        dom.loadDraftBtn.addEventListener('click', () => { const draft = JSON.parse(localStorage.getItem('emailDraft') || '{}'); if (Object.keys(draft).length === 0) { showMessage('æ²¡æœ‰æ‰¾åˆ°å·²ä¿å­˜çš„è‰ç¨¿ã€‚', true); return; } for (const key in draft) { const el = dom.emailForm.elements[key]; if (el) el.value = draft[key]; } dom.livePreview.innerHTML = draft.html || ''; showMessage('è‰ç¨¿å·²åŠ è½½ã€‚'); });
        dom.clearHistoryBtn.addEventListener('click', () => { if(confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å†å²è®°å½•å—ï¼Ÿ')) { localStorage.removeItem('emailHistory'); renderHistory(); } });
        dom.templateSelector.addEventListener('change', e => { const t = { welcome: { subject: 'æ¬¢è¿åŠ å…¥ï¼', html: '<h1>æ‚¨å¥½ï¼</h1><p>æ„Ÿè°¢æ‚¨çš„æ³¨å†Œã€‚</p>' }, reset: { subject: 'å¯†ç é‡ç½®', html: '<p>è¯·ç‚¹å‡» <a href="#">è¿™é‡Œ</a> é‡ç½®å¯†ç ã€‚</p>' } }[e.target.value]; if (t) { dom.emailForm.elements.subject.value = t.subject; dom.htmlTextarea.value = t.html; dom.livePreview.innerHTML = t.html; } });
        dom.htmlToolbar.addEventListener('click', e => { if (e.target.tagName !== 'BUTTON') return; const tag = e.target.dataset.tag; if (tag === 'img') { dom.imageEmbedInput.click(); return; } let url; if (tag === 'a') { url = prompt('è¯·è¾“å…¥é“¾æ¥åœ°å€:', 'https://'); if (!url) return; } const start = `<${tag}${url ? ` href="${url}"` : ''}>`, end = `</${tag}>`; dom.htmlTextarea.value += start + end; dom.livePreview.innerHTML = dom.htmlTextarea.value; dom.htmlTextarea.focus(); });
        dom.imageEmbedInput.addEventListener('change', e => { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (event) => { const imgTag = `<img src="${event.target.result}" alt="${file.name}" style="max-width: 100%; height: auto;">`; dom.htmlTextarea.value += imgTag; dom.livePreview.innerHTML = dom.htmlTextarea.value; }; reader.onerror = () => showMessage('è¯»å–å›¾ç‰‡æ–‡ä»¶å¤±è´¥ï¼', true); e.target.value = null; });
        
        dom.historyList.addEventListener('click', e => {
            const row = e.target.closest('tr');
            if (!row || !row.dataset.historyIndex) return;
            const history = getHistory()[row.dataset.historyIndex];
            const p = history.payload;
            let detailsHtml = `
                <div class="detail-grid">
                    <strong>ä¸»é¢˜:</strong>        <span>${p.subject}</span>
                    <strong>å‘ä»¶äºº:</strong>      <span>${p.from}</span>
                    <strong>æ”¶ä»¶äºº:</strong>      <span>${p.to.join(', ')}</span>
                    ${p.cc && p.cc.length ? `<strong>æŠ„é€:</strong><span>${p.cc.join(', ')}</span>` : ''}
                    ${p.bcc && p.bcc.length ? `<strong>å¯†é€:</strong><span>${p.bcc.join(', ')}</span>` : ''}
                    ${p.reply_to ? `<strong>å›å¤è‡³:</strong><span>${p.reply_to}</span>` : ''}
                    ${p.attachments && p.attachments.length ? `<strong>é™„ä»¶:</strong><span>${p.attachments.join('<br>')}</span>` : ''}
                    ${p.scheduled_at ? `<strong>å®šæ—¶å‘é€:</strong><span>${new Date(p.scheduled_at).toLocaleString()}</span>`: ''}
                </div>
                <hr>
                <p><strong>å†…å®¹é¢„è§ˆ:</strong></p>
                <div id="details-modal-preview">${p.html}</div>`;
            dom.detailsModalContent.innerHTML = detailsHtml;
            dom.detailsModal.style.display = 'block';
        });
        dom.closeDetailsModalBtn.addEventListener('click', () => dom.detailsModal.style.display = 'none');
    });
    </script>
</body>
</html>
